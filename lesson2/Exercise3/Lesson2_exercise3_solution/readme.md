# Exercise 3 Devicetree
In this exercise the goal is to get the application building. A common error we see at [DevZone](https://devzone.nordicsemi.com) is errors related to the devicetree. 
The application in the exercise is a simple application that will toggle a LED when button 1 is pressed. 

The exercise is created for the following Development kits nRF52840dk, nRF5340dk, nRF7001dk and nRF9160dk. If you don't have one of the following development kits you can still follow the exercise. 

### Step 1: 
Open Exercise 3 and create a build configuration for one of the mentioned supported boards 

### Step 2: 
The build should fail and give an error similar to 
```
error: '__device_dts_ord_11' undeclared here (not in a function); did you mean '__device_dts_ord_15'?
   85 | #define DEVICE_NAME_GET(dev_id) _CONCAT(__device_, dev_id)
      |                                         ^~~~~~~~~
ncs/v2.5.0/zephyr/include/zephyr/toolchain/common.h:132:26: note: in definition of macro '_DO_CONCAT'
  132 | #define _DO_CONCAT(x, y) x ## y
      |                          ^
ncs/v2.5.0/zephyr/include/zephyr/device.h:85:33: note: in expansion of macro '_CONCAT'
   85 | #define DEVICE_NAME_GET(dev_id) _CONCAT(__device_, dev_id)
      |                                 ^~~~~~~
ncs/v2.5.0/zephyr/include/zephyr/device.h:211:37: note: in expansion of macro 'DEVICE_NAME_GET'
  211 | #define DEVICE_DT_NAME_GET(node_id) DEVICE_NAME_GET(Z_DEVICE_DT_DEV_ID(node_id))
      |                                     ^~~~~~~~~~~~~~~
ncs/v2.5.0/zephyr/include/zephyr/device.h:228:34: note: in expansion of macro 'DEVICE_DT_NAME_GET'
  228 | #define DEVICE_DT_GET(node_id) (&DEVICE_DT_NAME_GET(node_id))
      |                                  ^~~~~~~~~~~~~~~~~~
ncs/v2.5.0/zephyr/include/zephyr/drivers/gpio.h:331:25: note: in expansion of macro 'DEVICE_DT_GET'
  331 |                 .port = DEVICE_DT_GET(DT_GPIO_CTLR_BY_IDX(node_id, prop, idx)),\
      |                         ^~~~~~~~~~~~~
ncs/v2.5.0/zephyr/include/zephyr/drivers/gpio.h:367:9: note: in expansion of macro 'GPIO_DT_SPEC_GET_BY_IDX'
  367 |         GPIO_DT_SPEC_GET_BY_IDX(node_id, prop, 0)
      |         ^~~~~~~~~~~~~~~~~~~~~~~
lesson2/Exercise3/src/main.c:15:40: note: in expansion of macro 'GPIO_DT_SPEC_GET'
   15 | static const struct gpio_dt_spec led = GPIO_DT_SPEC_GET(LED0_NODE, gpios);
 ```
 ### Step 3
 The build log shows we have an device error seen by ```__device_dts_ord_11``` 
 The "11" Node identifier. This node identifier can say something about the devicetree instance that is at fault. When you have the node identifier you can look up in ```<build>/zephyr/include/generated/devicetree_generated.h``` and find the ID found in the error message. 


 ### Step 4
In the devicetree_generated.h we can see the following 
```
*
 * Generated by gen_defines.py
 *
 * DTS input file:
 *  /build/zephyr/zephyr.dts.pre
 *
 * Directories with bindings:
 *  /ncs/v2.5.0/nrf/dts/bindings, $ZEPHYR_BASE/dts/bindings
 *
 * Node dependency ordering (ordinal and path):
 *   0   /
 *   1   /aliases
 *   2   /analog-connector
 *   3   /chosen
 *   4   /connector
 *   5   /entropy_bt_hci
 *   6   /soc
 *   7   /soc/interrupt-controller@e000e100
 *   8   /soc/timer@40009000
 *   9   /sw-pwm
 *   10  /buttons
 *   11  /soc/gpio@50000000
 *   12  /buttons/button_0
 *   13  /buttons/button_1
 *   14  /buttons/button_2
 *   15  /buttons/button_3
 *   16  /cpus
 *   17  /cpus/cpu@0
 *   18  /cpus/cpu@0/itm@e0000000
 *   19  /leds
 .....
 ```
 Our error message said the error was related to device id 11. In this case we can see it the /soc/gpio@50000000. The next step then should be to look at this module and ask the following questions: 
 1. Is the device enabled? 
 In order for the device to be enabled the property "status" shall be equal to "okay" and all required properties should be populated. 
 This can be verified by looking at the compiled devicetree found in <build>/zephyr/zephyr.dts

 2. Check if the device driver is enabled on Kconfig. In this case it would be to verify is ```CONFIG_GPIO=y``` 

### Step 5
By now the error should be clear. In the as we can see in zephyr.dts, the gpio0 is disabled 
```
		gpio0: gpio@50000000 {
			compatible = "nordic,nrf-gpio";
			gpio-controller;
			reg = <0x50000000 0x200
			       0x50000500 0x300>;
			#gpio-cells = <2>;
			status = "disabled";
			port = <0>;
		};
```
And in the overlay for the selected device we can see the following: 
```
 &gpio0 {
	status = "disabled";
};
```
In order to fix the application, enable gpio0: 
```
 &gpio0 {
	status = "okay";
};
```

### Step 6
Do a pristine build since we have done changes to our overlay. The application should now build. 
The devicetree can be overwhelming when moving from a bare metal environment, but should give some clues on how to solve potential errors you might face during development. 